#include <iostream>
#include <vector>
#include <string>
#include <ctime>
#include <iomanip>
#include <algorithm>
using namespace std;

struct Book {
    int id;
    string title;
    string author;
    string isbn;
    bool available;
};

struct Borrower {
    int id;
    string name;
};

struct Transaction {
    int id;
    int bookId;
    int borrowerId;
    time_t checkoutDate;
    time_t dueDate;
    time_t returnDate;
    bool returned;
};

class Library {
    vector<Book> books;
    vector<Borrower> borrowers;
    vector<Transaction> transactions;
    int bookCounter = 1;
    int borrowerCounter = 1;
    int transactionCounter = 1;
    int fineRate = 10;
public:
    void addBook(string t, string a, string i) {
        books.push_back({bookCounter++, t, a, i, true});
    }
    void addBorrower(string n) {
        borrowers.push_back({borrowerCounter++, n});
    }
    void listBooks() {
        cout << "Books:\n";
        for (auto &b : books) {
            cout << b.id << " " << b.title << " by " << b.author
                 << " ISBN:" << b.isbn << " "
                 << (b.available ? "Available" : "Checked out") << "\n";
        }
    }
    void searchBook(string q) {
        cout << "Search results:\n";
        for (auto &b : books) {
            if (b.title.find(q) != string::npos ||
                b.author.find(q) != string::npos ||
                b.isbn.find(q) != string::npos) {
                cout << b.id << " " << b.title << " by " << b.author << "\n";
            }
        }
    }
    void checkoutBook(int bookId, int borrowerId) {
        auto b = find_if(books.begin(), books.end(),
                         [&](Book &bk){return bk.id==bookId;});
        auto br = find_if(borrowers.begin(), borrowers.end(),
                          [&](Borrower &bw){return bw.id==borrowerId;});
        if (b==books.end() || br==borrowers.end()) {
            cout << "Invalid IDs\n"; return;
        }
        if (!b->available) {
            cout << "Book not available\n"; return;
        }
        time_t now = time(0);
        time_t due = now + 14*24*3600;
        transactions.push_back({transactionCounter++, bookId, borrowerId, now, due, 0, false});
        b->available = false;
        cout << "Book checked out. Due in 14 days.\n";
    }
    void returnBook(int transId) {
        auto t = find_if(transactions.begin(), transactions.end(),
                         [&](Transaction &tr){return tr.id==transId;});
        if (t==transactions.end()) { cout << "Invalid transaction\n"; return; }
        if (t->returned) { cout << "Already returned\n"; return; }
        t->returnDate = time(0);
        t->returned = true;
        auto b = find_if(books.begin(), books.end(),
                         [&](Book &bk){return bk.id==t->bookId;});
        if (b!=books.end()) b->available = true;
        int fine = calculateFine(*t);
        cout << "Book returned. Fine: " << fine << "\n";
    }
    int calculateFine(Transaction &t) {
        if (!t.returned) return 0;
        double daysLate = difftime(t.returnDate, t.dueDate)/(24*3600);
        if (daysLate>0) return (int)daysLate*fineRate;
        return 0;
    }
    void listTransactions() {
        cout << "Transactions:\n";
        for (auto &t : transactions) {
            cout << "ID:" << t.id << " Book:" << t.bookId
                 << " Borrower:" << t.borrowerId
                 << " Due:" << put_time(localtime(&t.dueDate), "%Y-%m-%d")
                 << " Returned:" << (t.returned?"Yes":"No") << "\n";
        }
    }
};

int main() {
    Library lib;
    lib.addBook("C++ Primer","Lippman","123");
    lib.addBook("Effective C++","Meyers","456");
    lib.addBorrower("Alice");
    lib.addBorrower("Bob");
    int choice;
    while (true) {
        cout << "\nMenu:\n1.List Books\n2.Search Book\n3.Checkout\n4.Return\n5.Transactions\n0.Exit\nChoice:";
        cin >> choice;
        if (choice==0) break;
        if (choice==1) lib.listBooks();
        else if (choice==2) {
            string q; cout<<"Query:"; cin>>q; lib.searchBook(q);
        }
        else if (choice==3) {
            int bid, br; cout<<"Book ID:";cin>>bid; cout<<"Borrower ID:";cin>>br;
            lib.checkoutBook(bid,br);
        }
        else if (choice==4) {
            int tid; cout<<"Transaction ID:";cin>>tid; lib.returnBook(tid);
        }
        else if (choice==5) lib.listTransactions();
    }
    return 0;
}
